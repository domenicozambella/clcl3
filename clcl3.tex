\documentclass{amsproc}
\usepackage{subfiles}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{comment}
\usepackage[alphabetic]{amsrefs}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{datetime2} 
\usepackage[colorlinks=true,linkcolor=blue,]{hyperref}
\usepackage{tcolorbox}
\usepackage{xstring}

\usepackage{stackengine}
\usepackage{scalerel}
\usepackage{mathtools}
\usepackage{calc}
\usepackage{amsthm}
\usepackage{thmtools}
\usepackage[framemethod=TikZ]{mdframed}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{euscript}
% \def\EuScript#1{\mathscr#1}
% \usepackage{fourier-otf}
\usepackage{fourier}
%\usepackage{palatino}
% \usepackage[sc]{mathpazo} % add possibly `sc` and `osf` options
%\usepackage{eulervm}
%\usepackage{bbm}
%\usepackage{latexsym}
% \usepackage{mathrsfs}
% \usepackage{stmaryrd}
% \usepackage{stix}
\def\dotminus{\stackon[.2ex]{$-$}{$.$}}
% \def\wneg{\stackon[-.2ex]{$\neg$}{$\neg$}}
\usepackage{dsfont}
% \newcommand*{\TakeFourierOrnament}[1]{{%
% \fontencoding{U}\fontfamily{futs}\selectfont\char#1}}
% \renewcommand*{\danger}{\TakeFourierOrnament{66}}
\parindent0ex
\parskip1.2ex
% \makeatletter
% \DeclareOldFontCommand{\rm}{\normalfont\rmfamily}{\mathrm}
% \DeclareOldFontCommand{\sf}{\normalfont\sffamily}{\mathsf}
% \DeclareOldFontCommand{\tt}{\normalfont\ttfamily}{\mathtt}
% \DeclareOldFontCommand{\bf}{\normalfont\bfseries}{\mathbf}
% \DeclareOldFontCommand{\it}{\normalfont\itshape}{\mathit}
% \DeclareOldFontCommand{\sl}{\normalfont\slshape}{\@nomath\sl}
% \DeclareOldFontCommand{\sc}{\normalfont\scshape}{\@nomath\sc}
% \makeatother

\newcommand{\mylabel}[1]{{#1}\hfill}
\renewenvironment{itemize}
  {\begin{list}{$\triangleright$}{%
  \setlength{\parskip}{0mm}
  \setlength{\topsep}{.1\baselineskip}
  \setlength{\rightmargin}{0mm}
  \setlength{\listparindent}{0mm}
  \setlength{\itemindent}{0mm}
  \setlength{\labelwidth}{3ex}
  \setlength{\itemsep}{.1\baselineskip}
  \setlength{\parsep}{.1\baselineskip}
  \setlength{\partopsep}{0mm}
  \setlength{\labelsep}{1ex}
  \setlength{\leftmargin}{\labelwidth+\labelsep}
  \let\makelabel\mylabel}}{%
\end{list}}


\newtheoremstyle{mio}% name
     {2\parskip}     % Space above
     {2\parskip}     % Space below
     {}%         Body font
     {}%         Indent amount (empty = no indent, \parindent = para indent)
     {\bfseries}% Thm head font
     {}%        Punctuation after thm head
     {1ex}%     Space after thm head: " " = normal interword space;
           %   \newline = linebreak
     {\llap{\thmnumber{#2}\hskip0.9ex}\thmname{#1}\thmnote{\bfseries{}#3}}% Thm head spec (can be left empty, meaning `normal')

\newcounter{thm}

\tcbset{
  mythm/.style={
    colback=black!5!white,
    colframe=white!50!black,
    extrude right by=2ex,
    extrude left by=6.5ex,
    % before=\par\noindent,
    % after=\par\noindent,
    top=0.7ex,
    bottom=1.5ex,
    right=2ex,
    left=6.5ex,
    boxsep=0pt,
    % parbox=false,
    before skip=\baselineskip,
    after skip=\baselineskip,
  },
}
\theoremstyle{mio}
\newtheorem{theorem}[thm]{Theorem}\tcolorboxenvironment{theorem}{mythm}
\newtheorem{corollary}[thm]{Corollary}\tcolorboxenvironment{corollary}{mythm}
\newtheorem{proposition}[thm]{Proposition}\tcolorboxenvironment{proposition}{mythm}
\newtheorem{lemma}[thm]{Lemma}\tcolorboxenvironment{lemma}{mythm}
\newtheorem{fact}[thm]{Fact}\tcolorboxenvironment{fact}{mythm}
\newtheorem{definition}[thm]{Definition}\tcolorboxenvironment{definition}{mythm}
\newtheorem{assumption}[thm]{Assumption}\tcolorboxenvironment{assumption}{mythm}
\newtheorem{void}[thm]{}\tcolorboxenvironment{void}{mythm}
\newtheorem{notation}[thm]{Notation}\tcolorboxenvironment{notation}{mythm}
\newtheorem{note}[thm]{Note}\tcolorboxenvironment{note}{mythm}
\newtheorem{remark}[thm]{Remark}\tcolorboxenvironment{remark}{mythm}
\newtheorem{definition_theorem}[thm]{Definition\,/\,Theorem}\tcolorboxenvironment{definition_theorem}{mythm}
\newtheorem{exercise}[thm]{Exercise}
\newtheorem{example}[thm]{Example}
\newtheorem{question}[thm]{Question}


\makeatletter
\providecommand{\proofNameStyle}{\bfseries}
\renewenvironment{proof}[1][\proofname]{\par
  \pushQED{\qed}%
  \normalfont% \topsep6\p@\@plus6\p@\relax
  % \vspace*{-\baselineskip}
  \trivlist
  \item[\hskip\labelsep
        \proofNameStyle
    #1\@addpunct{.}]\ignorespaces
}{%
  \popQED\endtrivlist\@endpefalse
}
\makeatother



\renewcommand*{\emph}[1]{%
   \smash{\tikz[baseline]\node[rectangle, fill=teal!25, rounded corners, inner xsep=0.5ex, inner ysep=0.2ex, anchor=base, minimum height = 2.7ex]{\strut #1};}}

%%%%%%% GETCOMMIT
\newcommand\dotGitHEAD{}
\newcommand\branch{}


\makeatletter\let\myfilehandle\@inputcheck\makeatother

\openin\myfilehandle=.git/HEAD\relax

\begingroup\endlinechar-1
  \global\read\myfilehandle to \dotGitHEAD
\endgroup
\closein\myfilehandle

\newcommand\GetBranch{}
\def\GetBranch ref: refs/heads/#1\relax{\renewcommand{\branch}{#1}}

\expandafter\GetBranch\dotGitHEAD\relax

\openin\myfilehandle=.git/refs/heads/\branch\relax

\begingroup\endlinechar-1
  \global\read\myfilehandle to \commit
\endgroup
\closein\myfilehandle

\makeatother

\linespread{1.1}
\author{L. S. Polymath}
% \author{Domenico Zambella}
% \author{al.}
\thanks{Dipartimento di Matematica, Universit\`a di Torino, via Carlo Alberto 10, 10123 Torino.}
\begin{document}
\title{Local stability in structures with a standard sort}
% \hfill\texttt{~}
\hfill\texttt{Branch \branch\ Commit \StrLeft{\commit}{7}\ \DTMnow}\par
\maketitle
\raggedbottom

\begin{abstract}
  Continuous logic~\cite{BBHU} has replaced Henson-Iovino logic~\cite{HI}, as a
  formalism to study model theory of continuous structures.
  One of the first articles on the subject, \cite{BU}, defines local stability within continuous logic - as noted by Henson, this escaped~\cite{HI}'s approach.
  Subsequently, this has been used as a major argument to advocate in favor of \cite{BBHU}'s over~\cite{HI}'s approach.\smallskip

  \noindent
  Recently, a classical approach to continuous structures has been proposed  in \cite{clcl} and~\cite{Z} that properly extend the class of structures that
  falls under the scope of~\cite{HI} or~\cite{BBHU}.
  These articles introduced the notion of structures with a standard sort.
  We discuss local stability in this context.
  We examine a few variants of the classical definition which are prima facie non equivalent.
  For each we prove that sets externally definable by a stable formulas are definable in some appropiate sense.
\end{abstract}

\def\medrel#1{\parbox{6ex}{\hfil $#1$}}
\def\ceq#1#2#3{\parbox[t]{13ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Structures with a standard sort}

Let \emph{$S$\/} be some Hausdorff compact topological space.
We associate to $S$ a first order structure in a language \emph{${\EuScript L}_{\sf S}$\/} that has a symbol for each compact subset $C\subseteq S$ and a function symbol for each continuous functions $f:S^n\to S$.
According to the context, $C$ and $f$ denote either the symbols of ${\EuScript L}_{\sf S}$ or their interpretation in the structure $S$.
Throughout these notes the letter $C$ always denotes a compact subset of $S$, or a tuple of such sets.

Finally, note that we could allow in ${\EuScript L}_{\sf S}$ relation symbols for all compact subsets of $S^n$, for any $n$.
But this would clutter the notation, therefore we prefer to entrust the straightforward generalization to the reader.%adding very little to the theory.

% Finally, note that we could allow in ${\EuScript L}_{\sf S}$ relation symbols for all compact subsets of $S^n$, for any $n$.
% But this would clutter the notation adding very little to the theory.
% When needed, we will assume this generalization and leave the detail to the reader.

We also fix an arbitrary first-order language which we denote by \emph{${\EuScript L}_{\sf H}$\/} and call the language of the home sort.

\begin{definition}\label{def_0}
  Let \emph{${\EuScript L}$\/} be a two sorted language. 
  The two sorts are denoted by \emph{${\sf H}$} and \emph{${\sf S}$.} 
  The language ${\EuScript L}$ expands ${\EuScript L}_{\sf H}$ and ${\EuScript L}_{\sf S}$ with symbols sort ${\sf H}^n\times{\sf S}^m\to {\sf S}$.
  An \emph{${\EuScript L}$-structure\/} is a structure of signature ${\EuScript L}$ that interprets these symbols in equicontinuous functions (i.e.\@ uniformly continuous w.r.t.\@ the variables in ${\sf H}$).

  A \emph{standard structure\/} is a two-sorted ${\EuScript L}$-structure of the form $\langle M,S\rangle$, where $M$ is any structure of signature ${\EuScript L}_{\sf H}$ and $S$ is fixed.
  Standard structures are denoted by the domain of their home sort.
\end{definition}

We denote by ${\EuScript F}$ the set of ${\EuScript L}$-formulas constructed inductively from atomic formulas of the form (i) and (ii) below using Boolean connectives $\wedge$, $\vee$; the quantifiers $\forall\raisebox{1.1ex}{\scaleto{\sf H}{.8ex}\kern-.2ex}$, $\exists\raisebox{1.1ex}{\scaleto{\sf H}{.8ex}\kern-.2ex}$ of sort ${\sf H}$; and the quantifiers $\forall\raisebox{1.1ex}{\scaleto{\sf S}{.8ex}\kern-.2ex}$, $\exists\raisebox{1.1ex}{\scaleto{\sf S}{.8ex}\kern-.2ex}$ of sort ${\sf S}$.

We write \emph{$x\in C$\/} for the predicate associated to a compact set $C$, and denote by $|\mbox{-}|$ the length of a tuple.

\begin{definition}
  We call atomic formulas those of the form
  \begin{itemize}
  \item[i.] atomic and negated atomic formulas of ${\EuScript L}_{\sf H}$
  % \item[ii.] $\tau\in C$, where $\tau$ is a $k$-tuple terms of sort ${\sf H}^n\times {\sf S}^m\to {\sf S}$, and $C$ a compact.
  \item[ii.] $\tau\in C$, where $\tau$ is a term of sort ${\sf H}^n\times {\sf S}^m\to {\sf S}$, and $C$ a compact.
  \end{itemize}
\end{definition}

We remark that smaller fragment of ${\EuScript F}$ may be of interest in some specific contexts.
This is obtained by excluding equalities and inequalities from (i) and requiring that $C$ in (ii) is regular.
The discussion below applies to this smaller fragment as well.

 Let $M\subseteq N$ be standard structures.
 We say that $M$ is an \emph{${\EuScript F}$-elementary\/} substructure of $N$ if the latter models all ${\EuScript F}(M)$-sentences that are true in $M$.

 Let $x$ and $\xi$ be variables of sort ${\sf H}$, respectively ${\sf S}$.
 A standard structure $M$ is \emph{${\EuScript F}$-saturated\/} if it realizes every type $p(x\,;\xi)\subseteq{\EuScript F}(A)$, for any $A\subseteq M$ of cardinality smaller than $|M|$, that is finitely consistent in $M$.
 The following theorem is proved in \cite{clcl} for signatures that do not contain symbols sort ${\sf H}^n\times{\sf S}^m\to {\sf S}$ with $n{\cdot}m>0$.
 A similar framework has been independently introduced in \cite{CP}~--~only without quantifiers of sort {\sf H} and with an approximate notion of satisfaction.
 The corresponding compactness theorem is proved there with a similar method.
 The setting in \cite{CP} is a generalization of that used by Henson and Iovino for Banach spaces~\cite{HI}.
 By the elimination of quantifiers of sort {\sf S}, proved in \cite{clcl}*{Proposition 3.6}, the two approaches are equivalent~--~up to approximations.

 In \cite{Z} it is observed that, under the assumption of equicontinuity, the proof in \cite{clcl} extends to the case $n{\cdot}m> 0$.

 \begin{theorem}[ (Compactness)]\label{thm_compactness}
  Every standard structure has a ${\EuScript F}$-saturated ${\EuScript F}$-elementary extension.
\end{theorem}

% We introduce some new sorts ${\sf X}_k$ with the sole scope of conveniently describing classes of ${\EuScript F}$-formulas that only differ by the sets/predicates $C\subseteq S^k$ they contain.
% Let ${\EuScript F}_{\sf X}$ be defined as ${\EuScript F}$ but supplementing (ii) with\smallskip

% \begin{itemize}
%   \item[iii.] $\tau(x\,;\xi)\in X$, where $X$ is a variable of sort ${\sf X}_k$.
% \end{itemize}

% Formulas in ${\EuScript F}_{\sf X}$ are denoted by $\varphi(x\,;\xi;X)$, where $X=X_1,\dots,X_n$ be a tuple of variables of sort ${\sf X}_{k_1},\dots,{\sf X}_{k_n}$.
% If $C=C _1,\dots,C_n$ is a tuple of compact subsets of  $S^{k_1},\dots,S^{k_n}$, then $\varphi(x\,;\xi;C)$, is a formula in ${\EuScript F}$.
% This we call an \emph{instance\/} of $\varphi(x\,;\xi;X)$.
% All formulas in ${\EuScript F}$ are instances of formulas in ${\EuScript F}_{\sf X}$.

We introduce a new sort ${\sf X}$ with the scope of conveniently describing classes of ${\EuScript F}$-for\-mulas that only differ by the sets/predicates $C\subseteq S$ they contain.
Let ${\EuScript F}_{\sf X}$ be defined as ${\EuScript F}$ but replacing (ii) by\smallskip

\begin{itemize}
  \item[iii.] $\tau(x\,;\xi)\in X$, where $X$ is a variable of sort ${\sf X}$.
\end{itemize}

Formulas in ${\EuScript F}_{\sf X}$ are denoted by $\varphi(x\,;\xi;X)$, where $X=X_1,\dots,X_n$ be a tuple of variables of sort ${\sf X}$.
If $C=C _1,\dots,C_n$ is a tuple of compact subsets, then $\varphi(x\,;\xi;C)$, is a formula in ${\EuScript F}$.
This we call an \emph{instance\/} of $\varphi(x\,;\xi;X)$.
All formulas in ${\EuScript F}$ are instances of formulas in ${\EuScript F}_{\sf X}$.

\begin{definition}
   Let $\varphi\in{\EuScript F}_{\sf X}$ be a formula~--~possibly with some (hidden) free variables.
   The \emph{pseudonegation\/} of $\varphi\in{\EuScript F}_{\sf X}$ is the formula obtained by replacing the atomic formulas in  ${\EuScript L}_{\sf H}$ by their negation and every connective $\wedge$, $\vee$, $\forall$, $\exists$
   %$\forall\raisebox{1.1ex}{\scaleto{\sf H}{.8ex}\kern-.2ex}$, $\exists\raisebox{1.1ex}{\scaleto{\sf H}{.8ex}\kern-.2ex}$, $\forall\raisebox{1.1ex}{\scaleto{\sf S}{.8ex}\kern-.2ex}$, $\exists\raisebox{1.1ex}{\scaleto{\sf S}{.8ex}\kern-.2ex}$ 
   by their respective duals $\vee$, $\wedge$, $\exists$, $\forall$.
   The atomic formulas of the form $\tau\in X$ remain unchanged.\smallskip
  % $\exists\raisebox{1.1ex}{\scaleto{\sf H}{.8ex}\kern-.2ex}$, $\forall\raisebox{1.1ex}{\scaleto{\sf H}{.8ex}\kern-.2ex}$, $\exists\raisebox{1.1ex}{\scaleto{\sf S}{.8ex}\kern-.2ex}$, $\forall\raisebox{1.1ex}{\scaleto{\sf S}{.8ex}\kern-.2ex}$.
   
  The pseudonegation of $\varphi$ is denoted by \emph{${\sim}\varphi$.}
  Clearly, when $X$ does not occur in $\varphi$, we have ${\sim}\varphi\leftrightarrow\neg\varphi$.
\end{definition}

It is sometimes conveniet to work with infinite conjunctions of formulas.
In the following $\sigma(x\,;z\,;X)$ denotes an ${\EuScript F}_{\sf X}$-type.
We write ${\sim}\sigma(x\,;z\,;X)$ for the infinite disjunction of the formulas ${\sim}\varphi(x\,;z\,;X)$ for $\varphi(x\,;z\,;X)\in\sigma$.

% Types are assumed to have cardinality $<\kappa$.
The following fact is immediate and will be used without further mention.
% $\varphi(x\,;z\,;X)$ denotes an ${\EuScript F}_{\sf X}$-formula and 

\begin{fact}\label{fact_trivial}
  The following hold for every $C\subseteq C'$ and $\tilde C\cap C=\varnothing$, every standard structure $M$, and every ${\EuScript F}_{\sf X}(M)$-type $\sigma(X)$\smallskip

  \ceq{\hfill M}{\models}{\phantom{\sim}\sigma(C)\ \rightarrow\phantom{\neg}\sigma(C')}\smallskip

  \ceq{\hfill M}{\models}{{\sim}\sigma(\tilde C)\ \rightarrow\neg\sigma(C).}\smallskip
  
\end{fact}

\begin{fact}
  For every $C\subseteq C'$ there is a $\tilde C\subseteq C'$ disjoint from $C$ such that\smallskip
  
  \ceq{\hfill M}{\models}{\varphi(C)\ \rightarrow\ \neg\,{\sim}\varphi(\tilde C)\ \rightarrow\ \varphi(C')}\smallskip

  for every $M$, and every ${\EuScript F}_{\sf X}(M)$-formula $\varphi(X)$.
  Conversely, for every $\tilde C\cap C=\varnothing$ there is a $C'\supseteq C$ such that

  \ceq{\hfill M}{\models}{\varphi(C)\ \rightarrow\ \varphi(C')\ \rightarrow\ \neg\,{\sim}\varphi(\tilde C)}.\smallskip

  for every $M$, and every ${\EuScript F}_{\sf X}(M)$-formula $\varphi(X)$.
\end{fact}

\begin{proof}
  When $\varphi(X)$ is the atomic formula $\tau\in X$, the first claim holds with $\tilde C=C'\smallsetminus O$ where $O$ is any open set $C\subseteq O\subseteq C'$.
  The second claim holds with as $C'$ any neighborhood of $C$ disjoint from $\tilde C$.
  Induction on the syntax of $\varphi(X)$ proves the general case.
\end{proof}

The above fact has the following useful consequence.

\begin{fact}\label{fact_otto}
  The following are equivalent for every standard structure $M$ , every ${\EuScript F}_{\sf X}(M)$-type $\sigma(X)$, and every $C$\smallskip
  
    \ceq{\hfill M}{\models}{\phantom{\neg}\sigma(C)\ \leftarrow\ \bigwedge\Big\{\ \sigma(C')\ :\ C'\textrm{ neighborhood of }C\Big\} }\smallskip

    \ceq{\hfill M}{\models}{\neg\sigma(C)\ \rightarrow\ \bigvee\Big\{{\sim}\sigma(\tilde C)\ :\ \tilde C\cap C=\varnothing\Big\}.}\smallskip

  (The converse implications are trivial~--~therefore not displayed.)
\end{fact}

\begin{fact}\label{fact_saturation}
  The equivalent conditions in Fact~\ref{fact_otto} hold in all ${\EuScript F}$-saturated structures.
\end{fact}

\begin{proof}
  \def\medrel#1{\parbox{5ex}{\hfil $#1$}}
  \def\ceq#1#2#3{\parbox[t]{39ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

  It suffices to prove the claim for formulas.
  We prove the first of the two implications by induction on the syntax of $\varphi(X)$.
  The existential quantifier of sort {\sf H} is the only connective that requires attention.
  Assume inductively that

    \ceq{\hfill\bigwedge\Big\{\ \varphi(a\,;C')\ :\ C'\textrm{ neighborhood of }C\Big\}}{\rightarrow}{\varphi(a\,;C)}

  holds for every $\varphi(a\,;C)$.
  Then induction for the existential quantifier follows from

    \ceq{\hfill\bigwedge\Big\{\ \exists x\,\varphi(x\,;C')\ :\ C'\textrm{ neighborhood of }C\Big\}}{\rightarrow}{\exists x\,\bigwedge\Big\{\varphi(x\,;C')\ :\ C'\textrm{ neighborhood of }C\Big\} }

    which is a consequence of saturation.
\end{proof}

We say that $M$ is \emph{${\EuScript F}$-maximal\/} if it models all ${\EuScript F}(M)$-sentences that hold in some of its ${\EuScript F}$-elementary extensions.
By Fact~\ref{fact_saturation} and the following, ${\EuScript F}$-saturated standard structures are ${\EuScript F}$-maximal.

\begin{fact}\label{fact_maximal}
  Let $M$ be a standard structure.
  Then the following are equivalent
  \begin{itemize}
    \item [1.] $M$ is ${\EuScript F}$-maximal
    \item [2.] the conditions in Fact~\ref{fact_otto} hold for every type (equivalently, for every formula). 
  \end{itemize}
\end{fact}

\begin{proof}
  1$\Rightarrow$2.
  If (2) in Fact~\ref{fact_otto} fails, $\neg\varphi(C)\wedge\neg\,{\sim}\varphi(\tilde C)$ holds in $M$ for every $\tilde C\cap C=\varnothing$.
  Let ${\EuScript U}$ be an ${\EuScript F}$-saturated ${\EuScript F}$-elementary extension of $M$.
  As $M$ is ${\EuScript F}$-maximal, $\neg\varphi(C)\wedge\neg\,{\sim}\varphi(\tilde C)$ holds also in ${\EuScript U}$.
  Then (2) in Fact~\ref{fact_otto} fails in ${\EuScript U}$, contradicting Fact~\ref{fact_saturation}.

  2$\Rightarrow$1. 
  Let $N$ be any ${\EuScript F}$-elementary extension of $M$.
  Suppose $N\models\varphi(C)$.
  By (2), it suffices to prove that $M\models\varphi(C')$ for every $C'$ neighborhood of $C$.
  Suppose not. Then, by (2) in Fact~\ref{fact_otto}, $M\models{\sim}\varphi(\tilde C)$ for some $\tilde C\cap C'=\varnothing$.
  Then $N\models{\sim}\varphi(\tilde C)$ by ${\EuScript F}$-elementarity.
  As $\tilde C\cap C=\varnothing$, this contradicts Fact~\ref{fact_saturation}.
\end{proof}

\begin{notation}
We denote by $\kappa$ the cardinality of ${\EuScript U}$.
We assume that $\kappa$ is a Ramsey cardinal.
However, the willing reader may check that we can do without large cardinals by carefull application of the Erd\H{o}s-Rado Theorem, see \cite{TZ}*{Appendix C.3}.\smallskip

In the following $\sigma(x\,;z\,;X)$ always denotes an ${\EuScript F}_{\sf X}({\EuScript U})$-type of small (i.e.\@ $<\kappa$) cardinality.
\end{notation}


% Unless otherwise specified, we work inside ${\EuScript U}$.
% Let $\varphi(X)\in{\EuScript F}_{\sf X}({\EuScript U})$ be given. Define

% \ceq{\hfill C_{\varphi}}{=}{\big\{\alpha\ :\ \varphi(C) \text{ holds for every } C \text{ neighborhood of } \alpha \big\}}

% Then $C_\varphi$ is a closed set.
% Note that either $C_\varphi$ or $C_{\sim\varphi}$ is empty by Fact~\ref{fact_trivial}.

% Let $\varepsilon$ a compact neighborhood of the diagonal of $S^2$.
% If $C$ is a tuple of compact subsets of $S$, we write $C^\varepsilon$ for the tuple whose elements are $\varepsilon$-close to the corresponding elements of $C$.
% For $b,b'\in{\EuScript U}^n$ we write $b\sim_\varepsilon b'$ if $\langle\tau(b,c),\tau(b',c)\rangle\in\varepsilon$ for every term $\tau(z,w)$ of sort ${\sf H}^{n+|w|}\to{\sf S}$ and every $c\in{\EuScript U}^w$.

% Then the equivalence relations $\sim_\varepsilon$ form the base for a uniformity.
% The coursest uniformity that makes every term $\tau(z,c)$ uniformly continuous

% \begin{fact}
%   The following are equivalent 
%   \begin{itemize}
%     \item [1.]  $b\sim_\varepsilon b'$.
%     \item [2.] For every $\varphi(x\,;z\,;X)$, every $c$, every $C$
    
%     \ceq{\hfill \varphi(c\,;b\,;C)}{\Rightarrow}{\varphi(c\,;b'\,;C^\varepsilon)}

%     and the same holds swapping $b$ and $b'$.
%   \end{itemize}
% \end{fact}

%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{A duality in \boldmath$K(S)$}\label{K(S)}

\def\medrel#1{\parbox{5ex}{\hfil $#1$}}
\def\ceq#1#2#3{\parbox[t]{23ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

Write \emph{$K(S)$\/} for the set of compact subsets of $S$.
In this section ${\EuScript D}$ and ${\EuScript C}$ range over subsets of $K(S)^n$.
We define 

\ceq{\hfill\emph{${\sim}{\EuScript D}$}}{=}{\big\{\tilde C\ :\ \tilde C\cap C\neq\varnothing\text{ for every }C\in{\EuScript D}\big\}.}

The following fact motivates the definition.

\begin{fact}\label{fact_~definibile}
  Let ${\EuScript D}=\{C\,:\,\sigma(C)\}$.
  Then ${\sim}{\EuScript D}=\{\tilde C\,:\,{\sim}\sigma(\tilde C)\}$.
\end{fact}

\begin{proof}
  We need to prove that 

  \ceq{\hfill{\sim}\sigma(\tilde C)}{\Leftrightarrow}{\text{for every } C,\ \text{ if } C\cap\tilde C=\varnothing\ \text{ then } \neg\sigma(C)}

  Implication $\Rightarrow$ follows immediately from Fact~\ref{fact_trivial}.
  To prove  $\Leftarrow$ assume the r.h.s.
  Then $\neg\sigma(S\smallsetminus O)$ holds for every open set  $O\supseteq\tilde C$.
  From the second implication in Fact~\ref{fact_otto} we obtain ${\sim}\sigma(\tilde C')$ for some $\tilde C\subseteq\tilde C'\subseteq O$.
  As $O$ is arbitrary, we obtain $\sigma(\tilde C)$ from the second implication in  Fact~\ref{fact_otto}.
\end{proof}

We prove a couple of straightforward inclusions.

\begin{fact}\label{fact_~inclusione}
  For every ${\EuScript D}\subseteq{\EuScript C}$ we have ${\sim}{\EuScript C}\subseteq{\sim}{\EuScript D}$.  
  Moreover, ${\EuScript D}\subseteq{\sim}{\sim}{\EuScript D}$.
\end{fact}

\begin{proof}
  Let $C\notin{\sim}{\EuScript D}$.
  Then $\tilde C\cap C=\varnothing$ for some $\tilde C\in{\EuScript D}$.
  As  $\tilde C\in{\EuScript C}$ we conclude that  $C\notin{\sim}{\EuScript C}$.
  For the second claim, let $C\notin{\sim}{\sim}{\EuScript D}$.
  Then $\tilde C\cap C=\varnothing$ for some $\tilde C\in{\sim}{\EuScript D}$.
  Then $C\notin{\EuScript D}$ follows.
\end{proof}

\begin{fact}
  For every ${\EuScript D}$ the following are equivalent
  \begin{itemize}
    \item [1.] ${\EuScript D}={\sim}{\sim}{\EuScript D}$.
    \item [2.] ${\EuScript D}={\sim}{\EuScript C}$ for some ${\EuScript C}$.
  \end{itemize}
\end{fact}
  
\begin{proof}
  Only 2$\Rightarrow$1 requires a proof.
  From Fact~\ref{fact_~inclusione} we obtain ${\sim}{\sim}{\sim}{\EuScript C}\subseteq{\sim}{\EuScript C}$.
  Assume (2) then ${\sim}{\sim}{\EuScript D}\subseteq{\EuScript D}$ which, again by Fact~\ref{fact_~inclusione}, suffices to prove (1).
\end{proof}

We say that ${\EuScript D}$ is \emph{involutive\/} if ${\EuScript D}={\sim}{\sim}{\EuScript D}$.
We say that ${\EuScript D}$ is \emph{closed\/} if 

\ceq{\hfill C\in{\EuScript D}}{\Leftrightarrow}{C'\in{\EuScript D}} for every neighborhood $C'$ of $C$.

Note that we are requiring closure in two distintic contexts: topological, and Boolean (upward clousere by inclusion).

\begin{theorem}
  The following are equivalent
  \begin{itemize}
    \item [1.] ${\EuScript D}$ is involutive 
    \item [2.] ${\EuScript D}$ is closed.
  \end{itemize}
\end{theorem}

\noindent\llap{\textcolor{red}{\Large\warning}\kern1.5ex}\ignorespaces
It is not difficult to see that (2) holds if and only if ${\EuScript D}$ is closed in the Vietoris topology and includes all the supersets of its elements.

\begin{proof}
  2$\Rightarrow$1.
  It suffices to prove ${\sim}{\sim}{\EuScript D}\subseteq{\EuScript D}$.
  Let $C\in{\sim}{\sim}{\EuScript D}$.
  Let $O\supseteq C$ be open.
  Then $S\smallsetminus O\notin{\sim}{\EuScript D}$.
  Then $\tilde C\in{\EuScript D}$ for some $\tilde C\subseteq O$.
  Assume (2).
  Then, by $\Rightarrow$ every $C'\supseteq O$ is in ${\EuScript D}$.
  As $O$ is arbitrary, $C\in {\EuScript D}$ by $\Leftarrow$.

  1$\Rightarrow$2.
  It suffices to show that (2) holds with ${\sim}{\EuScript D}$ for ${\EuScript D}$.
  Implication $\Rightarrow$ in the definition of closed is ovious.
  To prove $\Leftarrow$, assume $C\notin{\sim}{\EuScript D}$.
  Then $C\cap\tilde C$ for some $\tilde C\in{\EuScript D}$.
  Let $C'$ be a neighboorhood of $C$ disjoint of $C$.
  Then the r.h.s.\@ of the equivalence fails for $C'$.  
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Stable formulas~--~the finitary case}
\def\medrel#1{\parbox{5ex}{\hfil $#1$}}
\def\ceq#1#2#3{\parbox[t]{22ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

There is more than one way to define stability in our context.
In this section we present the strongest possible requirement.
It is not the most interesting one, but it is very similar to the classical definition~--~the comparision may be useful though not stricly required for the sequel.

% Let $\varphi(x\,;z\,;X)$ be a formulas in ${\EuScript F}_{\sf X}({\EuScript U})$.
% The variables of sort ${\sf H}$ are partitioned in two tuples $x\,;z$ which may be infinite.
The following is the classical definition of stability which we dub \textit{finitary\/} for the reason explained below.

\begin{definition}\label{def_finitary_stable}\strut
We say that $\varphi(x\,;z\,;C)$ is  \emph{finitarily stable\/} if for some $m<\omega$ there is no sequence $\langle a_i\,;b_i\ :\ i<m\rangle$ such that for every $i<n$\smallskip

\ceq{\hfill \varphi(a_n\,;b_i\,;C)}{\wedge}{\neg\varphi(a_i\,;b_n\,;C)}.
\end{definition}

From Fact~\ref{fact_otto} we easily obtain the following equivalent definition which only mentions formulas in ${\EuScript F}$.
The reader may wish to compare it with Definition~\ref{def_stable}.

\begin{fact}\label{fact_stability_semicalssic}
  The following are equivalent
  \begin{itemize}
    \item [1.]  $\varphi(x\,;z\,;C)$ is finitarily stable
    \item [2.]  for some $m$ there is no sequence $\langle a_i\,;b_i\,;\tilde C_i\ :\ i<m\rangle$ such that for every $i<n$\smallskip

    \ceq{\hfill \varphi(a_n\,;b_i\,;C)}{\wedge}{{\sim}\varphi(a_i\,;b_n\,;\tilde C_n)}\quad and\quad $C\cap\tilde C_i=\varnothing$.
  \end{itemize}
\end{fact}

In a classical context, i.e.\@ relying on ${\EuScript L}$-saturation, one can replace $m$ in Definition~\ref{def_finitary_stable} by $\omega$.
But this may not be true if only have ${\EuScript F}$-saturation.
Therefore we dedicate a separate section to the non-finitary version of stability.

The following definitions are classical, i.e.\@ they rely on the full language ${\EuScript L}$.

\begin{definition}\label{def_globaltype}\strut
  A \emph{global $\varphi(x\,;z\,;C)$-type\/} is a maximally (finitely) consistent set of formulas of the form $\varphi(x\,;b\,;C)$ or $\neg\varphi(x\,;b\,;C)$ for some $b\in{\EuScript U}^{|z|}$.
\end{definition}

Global $\varphi(x\,;z\,;C)$-types should not be confused with global $\varphi(x\,;z\,;X)$-types which are introduced in the following section.

In this section the symbol ${\EuScript D}$ always denotes a subset of ${\EuScript U}^z$.

\begin{definition}\label{def_approx}\strut
  We say that ${\EuScript D}$ is \emph{approximable\/} by $\varphi(x\,;z\,;C)$ if for every finite $B\subseteq {\EuScript U}^z$ there is an $a\in {\EuScript U}^x$ such that\smallskip

  \ceq{\hfill b\in {\EuScript D}}{\Leftrightarrow}{\varphi(a\,;b\,;C)}\hfill for every $b\in B$.
\end{definition}

It goes without saying that these definitions describe two faces of the same coin.
In fact, it is clear that ${\EuScript D}$ is approximable by $\varphi(x\,;z\,;C)$ if and only if  
    
  \noindent\kern-\labelwidth\kern-\labelsep
  \ceq{\hfill p(x)}{=}{\big\{\varphi(x\,;b\,;C)\ :\ b\in{\EuScript D}\big\}\ \ \cup\ \ \big\{\neg\varphi(x\,;b\,;C)\ :\ b\notin{\EuScript D}\big\}}

is a global $\varphi(x\,;z\,;C)$-type.\smallskip

The following theorem is often rephrased by saying that, when $\varphi(x\,;z\,;C)$ is finitarily stable, then all global $\varphi(x\,;z\,;C)$-types are definable.
The proof of the classical case applies verbatim because no saturation is required.
We state it here only for comparison with its non-finitary counterpart, see Theorem~\ref{thm_stability_definability}.

\begin{theorem}
  Let $\varphi(x\,;z\,;C)$ be finitarily stable.
  Let ${\EuScript D}$ be approximable by $\varphi(x\,;z\,;C)$.
  Then there are some $\langle a_{i,j}\ :\ i< k,\ j<m\rangle$ such that for every $b\in{\EuScript U}^z$\medskip

  \ceq{\hfill b\in{\EuScript D}}{\Leftrightarrow}{\bigvee_{i< k}\ \bigwedge_{j<m}\ \varphi(a_{i,j}\,;b\,;C)}
\end{theorem}


%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Stable formulas~--~the non-finitary case}
\def\medrel#1{\parbox{5ex}{\hfil $#1$}}
\def\ceq#1#2#3{\parbox[t]{22ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

We discuss a version of stability that seems more appropriate in this context.
There are two main differences with the previous section.
First, here the attribute \textit{stable\/} refers to a whole class of formulas~--~all instances of some $\varphi(x\,;z\,;X)$.
Second, the sequence witnessing the order property is required to be infinite.
As we need to extend the definition of stability to types, sequences of length $\kappa$ (a large cardinal) are used.

In this section  ${\EuScript D}$ is always a subset of ${\EuScript U}^z\times K(S)^n$, where $n$ has to be inferred from the context (tipically, $n=|X|$).
We write ${\sim}{\EuScript D}$ for the set obtained by applying the definition in Section~\ref{K(S)} to all fibers of ${\EuScript D}$.
We say that ${\EuScript D}$ is involutive/closed if all its fibers are such.

% The letters $\varepsilon$ and $\delta$ always denote definable compact symmetric neighborhood of the diagonal of $S^2$.
% By $\varepsilon+\delta$ we denote the composition $\varepsilon\circ\delta$, where the two sets are viewed as relations.
% If $C$ is a subsets of $S$, we write $C^\varepsilon$ for the set whose elements are $\varepsilon$-close to elements of $C$.
% We write $C^{\varepsilon\circ}$ for the set of elements that are $\varepsilon\!^\circ$-close to some  element of $C$, where $\varepsilon\!^\circ$ is the interior of $\varepsilon$.
% % Then $C^{\varepsilon\circ}$ is open.
% This definition extends naturally to when $C=C_1,\dots,C_k$.

\begin{definition}\label{def_stable}\strut
  We say that $\sigma(x\,;z\,;X)$ is \emph{stable\/} if there is no sequence $\langle a_i\,;b_i\ :\ i<\kappa\rangle$ such that for some $C$, some $\tilde C\cap C=\varnothing$\smallskip

  \ceq{\hfill \sigma(a_n\,;b_i\,;C)}{\wedge}{{\sim}\sigma(a_i\,;b_n\,;\tilde C)}\hfill for every $i<n<\kappa$\smallskip

  or for every $n<i<\kappa$.
\end{definition}

Note that when $\sigma(x\,;z\,;X)$ is a formula we can replace $\kappa$ with $\omega$ in the above definition.
For types we can equivalently require that there is no sequence $\langle a_i\,;b_i\ :\ i<\omega\rangle$ such that for some $C$, some $\tilde C\cap C=\varnothing$, some formula $\varphi(x\,;z\,;X)\in\sigma$\smallskip

  \ceq{\hfill \sigma(a_n\,;b_i\,;C)}{\wedge}{{\sim}\varphi(a_i\,;b_n\,;\tilde C)}\hfill for every $i<n<\kappa$\smallskip

or for every $n<i<\kappa$.

Note also that, by the pegeonhole principle, we can strengthen the requirement in Definition~\ref{def_stable} by requiring that there is no $\langle a_i\,;b_i\,;C_i\,;\tilde C_i\ :\ i<\omega\rangle$ such that $\tilde C_i\cap C_i=\varnothing$ and\smallskip

  \ceq{\hfill \sigma(a_n\,;b_i\,;C_i)}{\wedge}{{\sim}\varphi(a_i\,;b_n\,;\tilde C_n)}\hfill for every $i<n<\kappa$.\smallskip

\begin{definition}\strut 
  Let $\varphi(x\,;z\,;X)$ be a ${\EuScript F}_{\sf X}$-formula.
  A \emph{global $\varphi(x\,;z\,;X)$-type\/} is a maximally (finitely) consistent set of formulas of the form $\varphi(x\,;b\,;C)$ or ${\sim}\varphi(x\,;b\,;C)$ for some $b\in{\EuScript U}^{|z|}$ and some $C$.
\end{definition}

It is convenient to have a different characterization of global types, therefore  the following definition.

\begin{definition}\label{def_approx_X}\strut
  We say that ${\EuScript D}$ is \emph{approximable\/} by $\sigma(x\,;z\,;X)$ if for every small set $B\subseteq{\EuScript U}^z$ there is an $a\in{\EuScript U}^x$ such that\smallskip

  \ceq{1.\hfill \langle b,C\rangle\in{\EuScript D}}{\Rightarrow}{\varphi(a\,;b\,;C)}\quad and\smallskip

  \ceq{2.\hfill\langle b,C\rangle\in {\EuScript D}}{\Leftarrow}{\varphi(a\,;b\,;C)}\hfill for every $b\in B$ and every $C$.\smallskip
\end{definition}

In the above definition we quantify over all $B$ of small cardinality.
However, by compactness, the finite $B$ are sufficient (this is used without further mention in Section~\ref{almost}).

We remark that, by Facts~\ref{fact_~definibile} and~\ref{fact_~inclusione}, when ${\EuScript D}$ is involutive 
%(1) can be rephrased as
%
% \ceq{\hfill{\sim}\varphi(a\,;b\,;C)}{\Rightarrow}{\langle b,C\rangle\in{\sim}{\EuScript D}}\hfill for every $b\in B$ and every $C$.
%
% Analogously, 
(2) can be rephrased as

\ceq{\hfill \langle b,C\rangle\in{\sim}{\EuScript D}}{\Rightarrow}{{\sim}\sigma(a\,;b\,;C)}\hfill for every $b\in B$ and every $C$.

\begin{fact}
  Let $\varphi(x\,;z\,;X)$ be a ${\EuScript F}_{\sf X}$-formula.
  For every involutive ${\EuScript D}$ the following are equivalent
  \begin{itemize}
    \item [1.] ${\EuScript D}$ is approximable by $\varphi(x\,;z\,;X)$
    \item [2.] the following is a global $\varphi(x\,;z\,;X)$-type\smallskip
    
    \noindent\kern-\labelwidth\kern-\labelsep
    \ceq{\hfill p(x)}{=}{\big\{\phantom{\sim}\varphi(x\,;b\,;C)\ :\ \langle b,C\rangle\in{\EuScript D}\big\}\ \ \cup}\smallskip

    \noindent\kern-\labelwidth\kern-\labelsep
    \ceq{}{~}{\big\{{\sim}\varphi(x\,;b\,;C)\ :\ \langle b,C\rangle\in{\sim}{\EuScript D}\big\}.}
  
  \end{itemize}
\end{fact}

\begin{proof}
  First we prove that $p(x)$ is maximal as soon as it is consistent~--~in fact, this only depends on ${\EuScript D}$ being involutive.
  We need to consider two cases.
  First, assume that $\varphi(x\,;b\,;C)$ is consistent with $p(x)$.
  Then consistency implies that $\langle b,\tilde C\rangle\notin{\sim}{\EuScript D}$ for every $\tilde C\cap C=\varnothing$.
  But this implies that $C\in{\sim}{\sim}{\EuScript D}={\EuScript D}$, therefore $\varphi(x\,;b\,;C)\in p$.
  The second case is when ${\sim}\varphi(x\,;b\,;C)$ is consistent with $p(x)$.
  This implies that $\langle b,\tilde C\rangle\notin{\EuScript D}$ for every $\tilde C\cap C=\varnothing$.
  Then $\langle b,C\rangle\in{\sim}{\EuScript D}$,  therefore ${\sim}\varphi(x\,;b\,;C)\in p$.

  2$\Rightarrow$1.
  Let $B$ be a given finite subset of ${\EuScript U}^z$.
  The consistency of $p(x)\restriction B$ provides some $a$ such that for every finite $B$ an $a$ such that

  \ceq{\hfill \langle b,C\rangle\in {\EuScript D}}{\Rightarrow}{\phantom{\sim}\varphi(a\,;b\,;C)}\quad and 
  
  \ceq{\hfill \langle b,C\rangle\in{\sim}{\EuScript D}}{\Rightarrow}{{\sim}\varphi(a\,;b\,;C)}\hfill for every $b\in B$ and every $C$. 

  By what remarked above, these yield (1) and (2) in Definition~\ref{def_approx_X}.
  
  1$\Rightarrow$2. 
  Let $B$ be given.
  Let $a$ be as in Definition~\ref{def_approx_X}.
  Then, by what remarked above, $a\models p(x)\restriction B$.
\end{proof}

The proof of the main theorem of this section requires the following notion of approximation.
The definition is inspired by the classical notion of approximation from below in~\cite{Z15} where it is used as rephrasing of the notion of honest definability in~\cite{CS}.
Here this notion plays a purely technical role, but we submit it as potentially interesing in itself.

\begin{definition}\label{def_approx_blw}\strut
  We say that ${\EuScript D}$ is \emph{approximable\/} by $\sigma(x\,;z\,;X)$ \emph{from below\/} if for every finite $B\subseteq{\EuScript U}^z$ there is an $a\in{\EuScript U}^x$ such that for every $C$\smallskip

  \ceq{1.\hfill \langle b,C\rangle\in{\EuScript D}}{\Rightarrow}{\sigma(a\,;b\,;C)}\hfill for every $b\in B$ and\smallskip

  \ceq{2.\hfill\langle b,C\rangle\in {\EuScript D}}{\Leftarrow}{\sigma(a\,;b\,;C)}\hfill for every $b\in{\EuScript U}^z$.\smallskip
\end{definition}


% We remark that, by Facts~\ref{fact_~definibile} and~\ref{fact_~inclusione}, when ${\EuScript D}$ is involutive 
% %(1) can be rephrased as
% %
% % \ceq{\hfill{\sim}\varphi(a\,;b\,;C)}{\Rightarrow}{\langle b,C\rangle\in{\sim}{\EuScript D}}\hfill for every $b\in B$ and every $C$.
% %
% % Analogously, 
% (2) can be rephrased as

% \ceq{\hfill \langle b,C\rangle\in{\sim}{\EuScript D}_\varepsilon}{\Rightarrow}{{\sim}\varphi(a\,;b\,;C)}\hfill for every $b\in B$ and every $C$,

% where ${\EuScript D}_\varepsilon=\big\{C^\varepsilon\ :\ C\in{\EuScript D}\big\}$.

% \begin{fact}
%   For every involutive ${\EuScript D}$ the following are equivalent
%   \begin{itemize}
%     \item [1.] ${\EuScript D}$ is approximable
%     \item [2.] ${\EuScript D}$ is $\varepsilon$-approximable by $\varphi(x\,;z\,;X)$ for every $\varepsilon$
    
%   \end{itemize}
% \end{fact}

% \begin{proof}
%   Immediate.
% \end{proof}



\begin{theorem}\label{thm_stability_definability}
  Let $\sigma(x\,;z\,;X)$ be stable.
  Assume that ${\EuScript D}$ is approximable by $\sigma(x\,;z\,;X)$.
  Then there are some $\langle a_{i,j}\ :\ i<\lambda,j<\mu\rangle$ such that for every $b\in{\EuScript U}^z$ and every $C$\medskip

  \ceq{\hfill \langle b,C\rangle\in{\EuScript D}}{\Leftrightarrow}{\bigvee_{i<\lambda}\ \bigwedge_{j<\mu}\ \sigma(a_{i,j}\,;b\,;C)}\medskip

  % \ceq{\hfill \langle b,C\rangle\in{\EuScript D}}{\Leftarrow}{\bigvee_{i<\lambda}\ \bigwedge_{j<\mu}\ \sigma(a_{i,j}\,;b\,;C)}
\end{theorem}

\begin{proof}
  The theorem is an immediate consequence of the following three lemmas.
\end{proof}

\begin{lemma}
  Let $\sigma(x\,;z\,;X)$ be stable.
  Assume that ${\EuScript D}$ is approximable by $\sigma(x\,;z\,;X)$ from below.
  Then there is are some $\langle a_i\ :\ i<\lambda\rangle$ such that for every $b\in{\EuScript U}^z$ and every $C$\medskip

  \ceq{1.\hfill \langle b,C\rangle\in{\EuScript D}}{\Rightarrow}{\bigvee_{i<\lambda}\ \sigma(a_i\,;b\,;C)}\medskip 

  \ceq{2.\hfill \langle b,C\rangle\in{\EuScript D}}{\Leftarrow}{\bigvee_{i<\lambda}\ \sigma(a_i\,;b\,;C)} 
\end{lemma}

\begin{proof}
  We define recursively the required parameters $a_i$ together with some auxiliary parameters $b_i$.
  The element $a_n$ is choosen such that

\ceq{3.\hfill \langle b,C\rangle\in{\EuScript D}}{\Leftarrow}{\sigma(a_n\,;b\,;C)}\hfill for every $b\in{\EuScript U}^z$ and every $C$

and

\ceq{4.\hfill \langle b_i,C\rangle\in{\EuScript D}}{\Rightarrow}{\sigma(a_n\,;b_i\,;C)}\hfill for every $i<n$ and every $C$.\smallskip

This is possible because ${\EuScript D}$ is approximated from below.
Note that (3) immediately guarantees (2).
Now, assume (1) fails for $\lambda=n$, and choose $b_n$ and $C_n$ witnessing this.
Then, by Fact~\ref{fact_otto}, for some $\tilde C_n\cap C_n=\varnothing$

\ceq{5.\hfill \langle b_n,C_n\rangle\in{\EuScript D}}{\&}{\bigwedge_{i<n}\ {\sim}\sigma(a_i\,;b_n\,;\tilde C_n)}%\smallskip

Suppose for a contradiction that the construction never ends.
Then, as (5) guarantees that $\langle b_i,C_i\rangle\in{\EuScript D}$ for every $i$, from (4) we otain $\sigma(a_n\,;b_i\,;C_n)$ for every $i<n$.
From (5) we also obtain ${\sim}\sigma(a_i\,;b_n\,;\tilde C_n)$, for every $i\le n$.
This contradicts stability (as remarked after Definition~\ref{def_stable}).
\end{proof}

\begin{lemma}
  Let $\sigma(x\,;z\,;X)$ be stable. Then for some $\mu<\kappa$ the type\medskip 

  \ceq{\hfill\pi(\bar x\,;z\,;X)}{=}{\bigwedge_{i<\mu}\ \sigma(x_i\,;z\,;X),}\smallskip
  
  where the $x_i$ are copies of $x$ and $\bar x=\langle x_i\ :\ i<\mu\rangle$,
  approximates ${\EuScript D}$ from below.
\end{lemma}

\begin{proof}
  Negate the claim and let $B$ witness that $\pi(\bar x)$ does not approximate ${\EuScript D}$ from below.
  Suppose that $\langle a_i:i<n\rangle$ and $\langle b_i:i<n\rangle$ have been defined.
  Choose $a_n$ such that for every $b\in B\cup\{b_i:i<n\}$ and every $C$

  \ceq{1.\hfill\langle b,C\rangle\in{\EuScript D}}{\Rightarrow}{\varphi(a_n\,;b\,;C)}\quad and

  \ceq{2.\hfill\langle b,C\rangle\in{\EuScript D}}{\Leftarrow}{\varphi(a_n\,;b\,;C)}
  
  Note that the latter implication is equivalent to: for every $C$ there is some  $\tilde C\cap C=\varnothing$ such that 
  
  \ceq{3.\hfill \langle b,C\rangle\notin{\EuScript D}}{\Rightarrow}{{\sim}\varphi(a_n\,;b\,;\tilde C)}.%\hfill  for every $b\in B\cup\{b_0,\dots,b_{n-1}\}$.

  Now, as the lemma is assumed to fail, we can choose $b_n$ and $C_n$ such that

  \ceq{4.\hfill \langle b_n,C_n\rangle\notin{\EuScript D}}{\&}{\bigwedge_{i=0}^n\ \varphi(a_i\,;b_n\,;C_n)}

  Note that (4) ensure that $\langle b_i,C_i\rangle\notin{\EuScript D}$ for every $i$.
  The there is some $\tilde C_i$ that witnesses (3) for $\langle b_i,C_i\rangle\notin{\EuScript D}$.
  We claim that the procedure has to stop after $<\kappa$ steps.
  In fact, from (3) we obtain ${\sim}\varphi(a_n\,;b_i\,;\tilde C_i)$ for every $i<n$.
  On the other hand, by (4) we have that $\varphi(a_i\,;b_n\,;C_n)$ for every $i<n$.
  Therefore, $\langle a_i\,;b_i\,;C_i\,;\tilde C_i\ :\ i<\kappa\rangle$ contradicts stability (as remarked after Definition~\ref{def_stable}).
\end{proof}

\begin{lemma}\label{lem_sigma_stable}
  If $\sigma(x\,;z\,;X)$ is stable then $\pi(\bar x\,;z\,;X)$ in the previous lemma is stable.
\end{lemma}

\begin{proof}
  Suppose $\pi(\bar x\,;z\,;X)$ is unstable.
  Let $\langle \bar a_i\,;b_i\ :\ i<k\rangle$ be a sequence witnessing instability.
  Then for every pair $i<n$ there is some $j<\mu$ such that ${\sim}\sigma(a_{j,n}\,;b_i\,;\tilde C)$.
  Interprete such $j$ as a color. 
  As $\kappa$ is a Ramsey cardinal, every $\mu$-coloring of a complete graph of size $\kappa$ has a monocromatic subgraph of size $\kappa$.
  That is, there is a $j<\mu$ such that ${\sim}\sigma(a_{j,n}\,;b_i\,;\tilde C)$ obtains for $\kappa$ many $i$.
  Therefore we can extract a subsequence that contradicts the stability of $\sigma(x\,;z\,;X)$.
\end{proof}

% \subfile{delta}
\subfile{functions}
% \subfile{scribbles}
\subfile{almostfinitary}


\vskip10ex
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\ceq#1#2#3{\parbox[t]{23ex}{$\displaystyle #1$}\parbox{6ex}{\hfil $#2$}{$\displaystyle #3$}}

%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%

\BibSpec{arXiv}{%
  +{}{\PrintAuthors}{author}
  +{,}{ \textit}{title}
  +{}{ \parenthesize}{date}
  +{,}{ arXiv:}{eprint}
  +{,}{ } {note}
  % +{,}{ \url}
}

\BibSpec{webpage}{%
  +{}{\PrintAuthors} {author}
  +{,}{ \textit} {title}
  +{,}{ } {portal}
  +{}{ \parenthesize} {date}
  +{,}{ } {doi}
  +{,}{ } {note}
  +{.}{ } {transition}
}
\begin{bibdiv}
\begin{biblist}[]\normalsize

%   \bib{A}{article}{
%     label={A},
%     author={Auslander, Josef},
%     title={Topological Dynamics},
%     journal={Scholarpedia},
%     date={2008},
%     note={\href{http://scholarpedia.org/article/Topological_dynamics}{scholarpedia.3449}},
% }\smallskip
\bib{clcl}{article}{
    label={AAVV},
    author = {Agostini, Claudio},
    author = {Baratella, Stefano},
    author = {Barbina, Silvia},
    author = {Motto Ros, Luca},
    author = {Zambella, Domenico},
    title = {Continuous logic in a classical setting},
    note={t.a. in Bull. Iranian Math. Soc. \href{https://arxiv.org/abs/2402.01245}{arXiv:2402.01245}},
    date = {2025},
  }\smallskip

  \bib{B}{article}{
    label={B},
    author={Ben Yaacov, Ita\"{\i}},
    title={Model theoretic stability and definability of types, after A.
    Grothendieck},
    journal={Bull. Symb. Log.},
    volume={20},
    date={2014},
    number={4},
    pages={491--496},
    % issn={1079-8986},
    % review={\MR{3294276}},
    % doi={10.1017/bsl.2014.33},1306.5852
    note={\href{https://arxiv.org/abs/1306.5852}{arXiv:1306.5852}},
 }\smallskip
\bib{BBHU}{article}{
  label={BBHU},
  author={Ben Yaacov, Ita\"{\i}},
  author={Berenstein, Alexander},
  author={Henson, C. Ward},
  author={Usvyatsov, Alexander},
  title={Model theory for metric structures},
  conference={
      title={Model theory with applications to algebra and analysis. Vol. 2},
  },
  book={
      series={London Math. Soc. Lecture Note Ser.},
      volume={350},
      publisher={Cambridge Univ. Press, Cambridge},
  },
  %  isbn={978-0-521-70908-8},
  date={2008},
  pages={315--427},
  %  review={\MR{2436146}},
  %  doi={10.1017/CBO9780511735219.011},
}\smallskip
\bib{BU}{article}{
   label={BU},
   author={Ben Yaacov, Ita\"i},
   author={Usvyatsov, Alexander},
   title={Continuous first order logic and local stability},
   journal={Trans. Amer. Math. Soc.},
   volume={362},
   date={2010},
  %  number={10},
   pages={5213--5259},
  %  issn={0002-9947},
  %  review={\MR{2657678}},
  %  doi={10.1090/S0002-9947-10-04837-3},
  note={\href{https://arxiv.org/abs/0801.4303}{arXiv:0801.4303}},
}\smallskip
\bib{CP}{article}{
    label={CP},
   author={Chavarria, Nicolas},
   author={Pillay, Anand},
   title={On pp-elimination and stability in a continuous setting},
   journal={Ann. Pure Appl. Logic},
   volume={174},
   date={2023},
  %  number={5},
   pages={1--14},
  %  issn={0168-0072},
  %  review={\MR{4554677}},
  %  doi={10.1016/j.apal.2023.103258},
  note={\href{https://arxiv.org/abs/2107.14329}{arXiv:2107.14329}},
}\smallskip
\bib{CS}{article}{
  label={CS},
  author={Chernikov, Artem},
  author={Simon, Pierre},
  title={Externally definable sets and dependent pairs},
  journal={Israel J. Math.},
  volume={194},
  date={2013},
  number={1},
  pages={409--425},
  %note={},
  %issn={0021-2172},
  %doi={10.1007/s11856-012-0061-9},
  note={\href{https://arxiv.org/abs/1007.4468}{arXiv:1007.4468}},
}\smallskip
% \bib{G}{article}{
%   label={G},
%   author = {Goldbring, Isaac},
%   title = {Lecture notes on nonstandard analysis},
%   conference={
%     title={UCLA Summer School in Logic 2012}
%    },
%   eprint = {www.math.uci.edu/~isaac/NSA\%20notes.pdf},
% }

% \bib{H}{arXiv}{
%   label={H},
%   author = {Hart, Bradd},
%   title = {An Introduction To Continuous Model Theory},
%   eprint={2303.03969},
%   doi = {10.48550/arXiv.2303.03969},
%   url = {https://arxiv.org/abs/},
%   publisher = {arXiv},
%   date = {2023},
% }


% \bib{Hr}{article}{
%    label={Hr},
%    author={Hrushovski, Ehud},
%    title={Stable group theory and approximate subgroups},
%    journal={J. Amer. Math. Soc.},
%    volume={25},
%    date={2012},
%    number={1},
%    pages={189--243},
%    %issn={0894-0347},
%    %doi={10.1090/S0894-0347-2011-00708-S},
% }

% \bib{HPP}{article}{
%    label={HPP},
%    author={Hrushovski, Ehud},
%    author={Peterzil, Ya'acov},
%    author={Pillay, Anand},
%    title={Groups, measures, and the NIP},
%    journal={J. Amer. Math. Soc.},
%    volume={21},
%    date={2008},
%    number={2},
%    pages={563--596},
%   %  issn={0894-0347},
%   %  review={\MR{2373360}},
%   %  doi={10.1090/S0894-0347-07-00558-9},
% }

\bib{HI}{article}{
  label={HI},
  author={Henson, C. Ward},
  author={Iovino, Jos\'{e}},
  title={Ultraproducts in analysis},
  conference={
    title={Analysis and logic},
    address={Mons},
    date={1997},
   },
   book={
      series={London Math. Soc. Lecture Note Ser.},
      volume={262},
      publisher={Cambridge Univ. Press, Cambridge},
   },
   date={2002},
   pages={1--110},
  %  review={\MR{1967834}},
}\smallskip
% \bib{K}{article}{
%   label={K},
%   author = {Keisler, H. Jerome},
%   title = {Model Theory for Real-valued Structures},
%   book={
%     editor={Iovino, Jos\'e},
%     title ={{in} Beyond First Order Model Theory}, 
%     volume ={II},
%     publisher={Chapman and Hall/CRC},
%   % https://doi.org/10.1201/9780429263637
%     date = {2023},
%     note={\href{https://arxiv.org/abs/2005.11851}{arXiv:2005.11851}},
% % }
% }\smallskip
% \bib{Z}{arXiv}{
%   label = {Z},
%   author = {Zambella, Domenco},
%   note = {In preparation},
% }

% \bib{Z}{article}{
%   label={Z},
%    author={Zambella, Domenico},
%    title={Elementary classes of finite VC-dimension},
%    journal={Arch. Math. Logic},
%    volume={54},
%    date={2015},
%    number={5-6},
%    pages={511--520},
%   %  issn={0933-5846},
%   %  review={\MR{3372605}},
%   %  doi={10.1007/s00153-015-0424-0},
% }
\bib{TZ}{book}{
  label={TZ},
  author={Tent, Katrin},
  author={Ziegler, Martin},
  title={A course in model theory},
  series={Lecture Notes in Logic},
  volume={40},
  publisher={Association for Symbolic Logic, La Jolla, CA; Cambridge
  University Press, Cambridge},
  date={2012},
  pages={x+248},
%  isbn={978-0-521-76324-0},
%  review={\MR{2908005}},
%  doi={10.1017/CBO9781139015417},
}
\bib{Z15}{article}{
   label={Z15},
   author={Zambella, Domenico},
   title={Elementary classes of finite VC-dimension},
   journal={Arch. Math. Logic},
  %  volume={54},
   date={2015},
  %  number={5-6},
   pages={511--520},
   note={\href{https://arxiv.org/abs/1412.5781}{arXiv:1412.5781}},
  %  issn={0933-5846},
  %  review={\MR{3372605}},
  %  doi={10.1007/s00153-015-0424-0},
}\smallskip
\bib{Z}{article}{
  label={Z},
  author = {Zambella, Domenico},
  title = {Standard analysis},
  % doi = {10.48550/arXiv.2311.15711},
  note={\href{https://arxiv.org/abs/2311.15711}{arXiv:2311.15711}},
  date = {2023},
}\smallskip

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \section{Continuous group actions}
\end{biblist}
\end{bibdiv}
\end{document}